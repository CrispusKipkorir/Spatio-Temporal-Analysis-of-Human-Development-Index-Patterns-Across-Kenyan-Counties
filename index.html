<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Mapping Development in Kenya</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Libraries for map export -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }

        /* Centered main title */
        .title {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 1.4em;
            font-weight: bold;
            white-space: nowrap;
        }

        /* Author name bottom-left */
        .author {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: white;
            padding: 8px 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 0.9em;
        }

        /* Controls panel – starts below Leaflet zoom controls */
        .control-panel {
            position: absolute;
            top: 100px;
            left: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 340px;
            overflow: hidden;
            transition: width 0.3s ease;
        }
        .control-header {
            background: #f0f0f0;
            padding: 12px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .control-content { padding: 15px; }
        .collapsed .control-content { display: none; }
        .collapsed { width: 50px; }

        #year-slider { width: 100%; margin: 15px 0; }
        .slider-ticks {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9em;
            color: #555;
        }

        /* Legend – smaller, upper-right */
        .legend-panel {
            position: absolute;
            top: 60px;
            right: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 225px;
            overflow: hidden;
            transition: width 0.3s ease;
        }
        .legend-header {
            background: #f0f0f0;
            padding: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }
        .legend-content {
            padding: 10px;
            line-height: 22px;
            font-size: 0.85em;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .legend-color {
            width: 18px;
            height: 18px;
            border: 1px solid #aaa;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .legend-text { flex: 1; }
        .legend-range { font-size: 0.85em; color: #555; }
        .legend-label { font-weight: bold; margin-top: 2px; font-size: 0.9em; }

        /* Data Sources – directly below legend */
        .sources-panel {
            position: absolute;
            top: 300px;
            right: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 225px;
        }
        .sources-header {
            background: #f0f0f0;
            padding: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }
        .sources-content {
            padding: 10px;
            font-size: 0.85em;
            color: #444;
        }
        .sources-collapsed .sources-content { display: none; }

        /* Draggable comparison & export panel */
        .comparison-panel {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 420px;
            cursor: move;
            user-select: none;
        }
        .comparison-header {
            background: #f0f0f0;
            padding: 10px;
            cursor: move;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .comparison-content {
            padding: 12px;
            font-size: 0.88em;
            text-align: center;
        }
        #compare-btn, #export-btn {
            padding: 7px 14px;
            background: #0078e7;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin: 5px;
        }
        #compare-btn:disabled { background: #ccc; cursor: not-allowed; }
        #clear-compare {
            padding: 7px 14px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            display: none;
        }
        #selected-counties { margin: 10px 0; font-weight: bold; color: #333; }
        #comparison-values {
            margin-top: 8px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 4px;
            font-size: 0.92em;
            line-height: 1.5;
        }
        .comparison-collapsed .comparison-content { display: none; }
        .comparison-collapsed { height: 42px; }

        /* About indicators panel – bottom centre */
        .about-panel {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 80%;
            max-width: 900px;
            max-height: 40vh;
            overflow-y: auto;
            padding: 15px;
            font-size: 0.9em;
        }
        .about-header {
            background: #f0f0f0;
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin: -15px -15px 15px -15px;
        }
        .about-content h3 { margin-top: 20px; font-size: 1.1em; }
        .about-content a { color: #0078e7; text-decoration: underline; }
        .about-collapsed .about-content { display: none; }

        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="title">Mapping Development in Kenya</div>
    <div class="author">Crispus Kipkorir</div>

    <!-- Controls Panel -->
    <div class="control-panel" id="controlPanel">
        <div class="control-header" onclick="togglePanel('controlPanel')">
            <span>Controls</span>
            <i class="fas fa-chevron-left"></i>
        </div>
        <div class="control-content">
            <strong>Select Indicator:</strong><br>
            <select id="indicator" onchange="updateMap()" style="width:100%; padding:8px; margin-top:8px;">
                <option value="Human Development Index.geojson">Human Development Index (HDI)</option>
                <option value="HeadCount Ratio.geojson">Poverty Headcount Ratio (%)</option>
                <option value="Intensity of depreviation.geojson">Intensity of Deprivation (%)</option>
                <option value="Multi dimensional poverty.geojson">Multidimensional Poverty Index (MPI)</option>
                <option value="Poverty Severity.geojson">Poverty Severity (% in Severe Poverty)</option>
                <option value="Vulnerability.geojson">Vulnerability to Poverty (%)</option>
            </select>

            <div style="margin-top:20px;">
                <strong>Year:</strong> <span id="year-label">2025</span>
                <input type="range" id="year-slider" min="2015" max="2030" value="2025" step="5" oninput="updateMap()">
                <div class="slider-ticks">
                    <span>2015</span>
                    <span>2020</span>
                    <span>2025</span>
                    <span>2030</span>
                </div>
            </div>

            <div id="national-info" style="margin-top:15px; font-weight:bold;"></div>
            <div style="margin-top:10px; font-size:0.9em; color:#666;">
                County-level data available only for recent period (~2025).<br>
                For other years, national Kenya value is shown.
            </div>
        </div>
    </div>

    <!-- Legend Panel -->
    <div class="legend-panel hidden" id="legendPanel">
        <div class="legend-header" onclick="togglePanel('legendPanel')">
            <span>Legend</span>
            <i class="fas fa-chevron-up"></i>
        </div>
        <div class="legend-content" id="legendContent"></div>
    </div>

    <!-- Data Sources Panel -->
    <div class="sources-panel sources-collapsed" id="sourcesPanel">
        <div class="sources-header" onclick="togglePanel('sourcesPanel')">
            <span>Data Sources</span>
            <i class="fas fa-chevron-up"></i>
        </div>
        <div class="sources-content">
            <strong>County-level data (~2025):</strong><br>
            • Kenya National Bureau of Statistics (KNBS)<br>
            • Oxford Poverty and Human Development Initiative (OPHI)<br>
            • UNDP Human Development Report<br><br>
            <strong>National trends:</strong><br>
            • UNDP Human Development Reports (2015–2023)<br>
            • KNBS Economic Surveys & Poverty Reports<br>
            • World Bank Kenya Poverty Assessments
        </div>
    </div>

    <!-- Comparison & Export Panel -->
    <div class="comparison-panel" id="comparisonPanel">
        <div class="comparison-header" id="comparisonDragHandle">
            <span>County Comparison & Export</span>
            <i class="fas fa-chevron-down"></i>
        </div>
        <div class="comparison-content">
            <div>Click up to two counties on the map (2025 view only) to compare.</div>
            <button id="compare-btn" disabled>Start Side-by-Side View</button>
            <button id="export-btn">Export Map</button>
            <button id="clear-compare">Clear</button>
            <div id="selected-counties">No counties selected</div>
            <div id="comparison-values"></div>
        </div>
    </div>

    <!-- About the Indicators Panel -->
    <div class="about-panel" id="aboutPanel">
        <div class="about-header" onclick="togglePanel('aboutPanel')">
            <span>About the Indicators</span>
            <i class="fas fa-chevron-down"></i>
        </div>
        <div class="about-content">
            <h3><strong>Human Development Index (HDI)</strong></h3>
            <p>The HDI is a composite index measuring average achievement in three basic dimensions of human development: a long and healthy life, knowledge, and a decent standard of living. County-level HDIs in Kenya are estimated based on national UNDP methodology, using indicators like life expectancy, education attainment, and income. Source: <a href="https://hdr.undp.org/data-center/human-development-index" target="_blank">UNDP Human Development Reports</a> and KNBS projections.</p>

            <h3><strong>Poverty Headcount Ratio (%)</strong></h3>
            <p>This measures the percentage of the population living below the national poverty line (unable to meet basic food and non-food needs). Calculated using household consumption expenditure data from surveys. Source: <a href="https://www.knbs.or.ke/" target="_blank">Kenya National Bureau of Statistics (KNBS)</a>.</p>

            <h3><strong>Intensity of Deprivation (%)</strong></h3>
            <p>In the multidimensional poverty framework, this represents the average percentage of weighted deprivations experienced by multidimensionally poor people (e.g., in health, education, living standards). It complements the headcount by showing how intensely poverty is experienced. Source: Adapted from <a href="https://ophi.org.uk/multidimensional-poverty-index/" target="_blank">OPHI/UNDP Global MPI methodology</a>.</p>

            <h3><strong>Multidimensional Poverty Index (MPI)</strong></h3>
            <p>The MPI identifies multiple deprivations at the household level in health, education, and living standards. It is the product of incidence (headcount) and intensity of poverty. County data derived from DHS/MICS surveys using Alkire-Foster method. Source: <a href="https://ophi.org.uk/multidimensional-poverty-index/" target="_blank">Oxford Poverty & Human Development Initiative (OPHI) and UNDP</a>.</p>

            <h3><strong>Poverty Severity (% in Severe Poverty)</strong></h3>
            <p>This captures the severity of poverty among the poor, often related to hardcore/extreme poverty (below food poverty line) or squared poverty gap. Reflects deeper deprivation. Source: <a href="https://www.knbs.or.ke/" target="_blank">KNBS Poverty Reports</a>.</p>

            <h3><strong>Vulnerability to Poverty (%)</strong></h3>
            <p>Percentage of population at risk of falling into poverty due to shocks (e.g., slightly above poverty line but vulnerable). Often those near the poverty threshold. Source: KNBS and World Bank assessments.</p>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-side-by-side@2.2.0/leaflet-side-by-side.min.js"></script>
    <script>
        // Set up the base map
        const map = L.map('map').setView([0.5, 37.8], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Tracking variables
        let currentLayer = null;
        let messageOverlay = null;
        let sideBySideControl = null;
        let selectedFeatures = [];

        // National values for years without county data
        const nationalData = {
            "Human Development Index.geojson": { 2015: "0.555", 2020: "~0.575", 2025: "0.628 (2023)", 2030: "Projected ~0.70" },
            "HeadCount Ratio.geojson": { 2015: "36.1% (2015/16)", 2020: "~42% (COVID peak)", 2025: "39.8% (2022)", 2030: "Target <30%" },
            "Intensity of depreviation.geojson": { 2015: "~45%", 2020: "~48%", 2025: "~50%", 2030: "Target reduction" },
            "Multi dimensional poverty.geojson": { 2015: "~0.20", 2020: "~0.18", 2025: "0.113 (2022)", 2030: "Target <0.10" },
            "Poverty Severity.geojson": { 2015: "~10%", 2020: "~15%", 2025: "~12%", 2030: "Target low" },
            "Vulnerability.geojson": { 2015: "~25%", 2020: "~30%", 2025: "~28%", 2030: "Target <20%" }
        };

        // Indicator configurations
        const indicators = {
            "Human Development Index.geojson": {
                property: "HDI",
                countyProp: "adm1_name",
                title: "Human Development Index (HDI)",
                popupLabel: "HDI",
                colorBreaks: [
                    { max: 0.420, color: "#f03b20", label: "Very Low" },
                    { max: 0.478, color: "#fd8d3c", label: "Low" },
                    { max: 0.532, color: "#fecc5c", label: "Moderate" },
                    { max: 0.586, color: "#ffffb2", label: "High" },
                    { max: Infinity, color: "#41ab5d", label: "Very High" }
                ],
                ranges: ["< 0.420", "0.420 – 0.478", "0.478 – 0.532", "0.532 – 0.586", "≥ 0.586"]
            },
            "HeadCount Ratio.geojson": {
                property: "Headcount",
                countyProp: "adm1_name",
                title: "Poverty Headcount Ratio (%)",
                popupLabel: "Headcount Ratio (%)",
                colorBreaks: [
                    { max: 17.932, color: "#f7f7f7", label: "Very Low" },
                    { max: 24.556, color: "#fcc5c0", label: "Low" },
                    { max: 28.927, color: "#fa9fb5", label: "Moderate" },
                    { max: 45.989, color: "#de77ae", label: "High" },
                    { max: Infinity, color: "#c51b8a", label: "Very High" }
                ],
                ranges: ["2.671 – 17.932", "17.932 – 24.556", "24.556 – 28.927", "28.927 – 45.989", "45.989 – 81.336"]
            },
            "Intensity of depreviation.geojson": {
                property: "Intensity",
                countyProp: "adm1_name",
                title: "Intensity of Deprivation (%)",
                popupLabel: "Intensity (%)",
                colorBreaks: [
                    { max: 42.703, color: "#ffffff", label: "Very Low" },
                    { max: 47.639, color: "#ffcccc", label: "Low" },
                    { max: 52.575, color: "#ff9999", label: "Moderate" },
                    { max: 57.512, color: "#ff6666", label: "High" },
                    { max: Infinity, color: "#ff0000", label: "Very High" }
                ],
                ranges: ["37.767 – 42.703", "42.703 – 47.639", "47.639 – 52.575", "52.575 – 57.512", "57.512 – 62.448"]
            },
            "Multi dimensional poverty.geojson": {
                property: "MPI",
                countyProp: "adm1_name",
                title: "Multidimensional Poverty Index (MPI)",
                popupLabel: "MPI",
                colorBreaks: [
                    { max: 0.07238, color: "#ffffff", label: "Very Low" },
                    { max: 0.09986, color: "#d9d9d9", label: "Low" },
                    { max: 0.11938, color: "#bdbdbd", label: "Moderate" },
                    { max: 0.20892, color: "#969696", label: "High" },
                    { max: Infinity, color: "#636363", label: "Very High" }
                ],
                ranges: ["0.01030 – 0.07238", "0.07238 – 0.09986", "0.09986 – 0.11938", "0.11938 – 0.20892", "0.20892 – 0.49680"]
            },
            "Poverty Severity.geojson": {
                property: "In Severe",
                countyProp: "adm1_name",
                title: "Poverty Severity (% in Severe Poverty)",
                popupLabel: "Severity (%)",
                colorBreaks: [
                    { max: 1.939, color: "#ffffff", label: "Very Low" },
                    { max: 3.732, color: "#ffcccc", label: "Low" },
                    { max: 6.134, color: "#ff9999", label: "Moderate" },
                    { max: 17.500, color: "#ff6666", label: "High" },
                    { max: Infinity, color: "#cc0000", label: "Very High" }
                ],
                ranges: ["0.221 – 1.939", "1.939 – 3.732", "3.732 – 6.134", "6.134 – 17.500", "17.500 – 64.885"]
            },
            "Vulnerability.geojson": {
                property: "Vulnerable",
                countyProp: "adm1_name",
                title: "Vulnerability to Poverty (%)",
                popupLabel: "Vulnerability (%)",
                colorBreaks: [
                    { max: 18.111, color: "#ffffff", label: "Very Low" },
                    { max: 24.922, color: "#ffcccc", label: "Low" },
                    { max: 31.066, color: "#ff9999", label: "Moderate" },
                    { max: 34.263, color: "#ff6666", label: "High" },
                    { max: Infinity, color: "#ff0000", label: "Very High" }
                ],
                ranges: ["9.211 – 18.111", "18.111 – 24.922", "24.922 – 31.066", "31.066 – 34.263", "34.263 – 43.376"]
            }
        };

        // Colour and category helpers
        function getColor(value, breaks) {
            for (let b of breaks) {
                if (value < b.max) return b.color;
            }
            return breaks[breaks.length - 1].color;
        }

        function getCategory(value, breaks) {
            for (let b of breaks) {
                if (value < b.max) return b.label;
            }
            return breaks[breaks.length - 1].label;
        }

        // Panel collapse toggle
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            panel.classList.toggle('collapsed');
            if (panelId === 'sourcesPanel') panel.classList.toggle('sources-collapsed');
            if (panelId === 'comparisonPanel') panel.classList.toggle('comparison-collapsed');
            if (panelId === 'aboutPanel') panel.classList.toggle('about-collapsed');
        }

        // Draggable comparison panel
        const comparisonPanel = document.getElementById('comparisonPanel');
        const dragHandle = document.getElementById('comparisonDragHandle');
        let isDragging = false;
        let currentX = window.innerWidth / 2 - 210;
        let currentY = window.innerHeight - 100;
        let initialX, initialY;

        dragHandle.addEventListener('mousedown', (e) => {
            initialX = e.clientX - currentX;
            initialY = e.clientY - currentY;
            isDragging = true;
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                comparisonPanel.style.left = currentX + 'px';
                comparisonPanel.style.top = currentY + 'px';
                comparisonPanel.style.transform = 'none';
            }
        });

        document.addEventListener('mouseup', () => { isDragging = false; });

        // Update comparison panel UI
        function updateComparisonUI() {
            const config = indicators[document.getElementById('indicator').value];
            const btn = document.getElementById('compare-btn');
            const clearBtn = document.getElementById('clear-compare');
            const label = document.getElementById('selected-counties');
            const valuesDiv = document.getElementById('comparison-values');

            if (selectedFeatures.length === 0) {
                label.textContent = 'No counties selected';
                valuesDiv.innerHTML = '';
                btn.disabled = true;
                clearBtn.style.display = 'none';
            } else if (selectedFeatures.length === 1) {
                const county = selectedFeatures[0].properties[config.countyProp];
                const val = selectedFeatures[0].properties[config.property]?.toFixed(3) || 'N/A';
                const cat = getCategory(selectedFeatures[0].properties[config.property], config.colorBreaks);
                label.textContent = `Selected: ${county}`;
                valuesDiv.innerHTML = `<strong>${county}</strong><br>${config.popupLabel}: ${val}<br>Category: ${cat}`;
                btn.disabled = true;
                clearBtn.style.display = 'inline-block';
            } else {
                const c1 = selectedFeatures[0].properties[config.countyProp];
                const c2 = selectedFeatures[1].properties[config.countyProp];
                const v1 = selectedFeatures[0].properties[config.property]?.toFixed(3) || 'N/A';
                const v2 = selectedFeatures[1].properties[config.property]?.toFixed(3) || 'N/A';
                const cat1 = getCategory(selectedFeatures[0].properties[config.property], config.colorBreaks);
                const cat2 = getCategory(selectedFeatures[1].properties[config.property], config.colorBreaks);
                label.textContent = `Selected: ${c1} vs ${c2}`;
                valuesDiv.innerHTML = `
                    <strong>${c1}</strong>: ${config.popupLabel} ${v1} (${cat1})<br>
                    <strong>${c2}</strong>: ${config.popupLabel} ${v2} (${cat2})
                `;
                btn.disabled = false;
                clearBtn.style.display = 'inline-block';
            }
        }

        // Clear comparison
        function clearComparison() {
            selectedFeatures = [];
            if (sideBySideControl) {
                map.removeControl(sideBySideControl);
                sideBySideControl = null;
            }
            if (currentLayer) currentLayer.eachLayer(l => l.setStyle({weight: 1.5, color: 'white', fillOpacity: 0.7}));
            updateComparisonUI();
        }
        document.getElementById('clear-compare').onclick = clearComparison;

        // Side-by-side view
        document.getElementById('compare-btn').onclick = () => {
            if (selectedFeatures.length !== 2) return;
            const config = indicators[document.getElementById('indicator').value];
            const layer1 = L.geoJSON(selectedFeatures[0], {
                style: {fillColor: getColor(selectedFeatures[0].properties[config.property], config.colorBreaks), weight: 4, color: '#000', fillOpacity: 0.8}
            });
            const layer2 = L.geoJSON(selectedFeatures[1], {
                style: {fillColor: getColor(selectedFeatures[1].properties[config.property], config.colorBreaks), weight: 4, color: '#000', fillOpacity: 0.8}
            });
            if (sideBySideControl) map.removeControl(sideBySideControl);
            sideBySideControl = L.control.sideBySide(layer1, layer2).addTo(map);
        };

        // Export map
        document.getElementById('export-btn').onclick = () => {
            const choice = prompt('Export map as:\n1. PNG\n2. JPG\n3. PDF\n\nEnter 1, 2 or 3', '1');
            if (!['1','2','3'].includes(choice)) {
                alert('Please choose 1, 2 or 3');
                return;
            }

            const panels = document.querySelectorAll('.control-panel, .legend-panel, .sources-panel, .comparison-panel, .about-panel, .title, .author');
            panels.forEach(p => p.style.visibility = 'hidden');

            html2canvas(document.getElementById('map'), {useCORS: true, allowTaint: true, backgroundColor: '#ffffff'}).then(canvas => {
                const imgData = canvas.toDataURL(choice === '2' ? 'image/jpeg' : 'image/png');

                if (choice === '3') {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                        unit: 'px',
                        format: [canvas.width, canvas.height]
                    });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save('kenya-development-map.pdf');
                } else {
                    const link = document.createElement('a');
                    link.download = `kenya-development-map.${choice === '2' ? 'jpg' : 'png'}`;
                    link.href = imgData;
                    link.click();
                }

                panels.forEach(p => p.style.visibility = 'visible');
            });
        };

        // Core map update function
        function updateMap() {
            const file = document.getElementById('indicator').value;
            const config = indicators[file];
            const year = parseInt(document.getElementById('year-slider').value);
            document.getElementById('year-label').textContent = year;
            document.getElementById('national-info').innerHTML = `<strong>National Kenya (${year}):</strong> ${nationalData[file][year]}`;

            if (currentLayer) map.removeLayer(currentLayer);
            if (messageOverlay) map.removeLayer(messageOverlay);
            if (sideBySideControl) { map.removeControl(sideBySideControl); sideBySideControl = null; }
            document.getElementById('legendPanel').classList.add('hidden');
            document.getElementById('legendContent').innerHTML = '';
            clearComparison();

            if (year === 2025) {
                const rawUrl = "https://raw.githubusercontent.com/CrispusKipkorir/Mapping-Development-in-Kenya/main/" + encodeURIComponent(file);
                fetch(rawUrl)
                    .then(r => { if (!r.ok) throw new Error(); return r.json(); })
                    .then(data => {
                        currentLayer = L.geoJSON(data, {
                            style: feature => ({
                                fillColor: getColor(feature.properties[config.property] || 0, config.colorBreaks),
                                weight: 1.5,
                                opacity: 1,
                                color: 'white',
                                fillOpacity: 0.7
                            }),
                            onEachFeature: (feature, layer) => {
                                const p = feature.properties;
                                const county = p[config.countyProp] || 'Unknown';
                                const val = p[config.property] !== undefined ? Number(p[config.property]).toFixed(3) : 'N/A';
                                const cat = p[config.property] !== undefined ? getCategory(p[config.property], config.colorBreaks) : '';
                                layer.bindPopup(`<strong>${county}</strong><br>${config.popupLabel}: ${val}<br>Category: ${cat}`);

                                layer.on('click', () => {
                                    if (selectedFeatures.includes(feature)) {
                                        selectedFeatures = selectedFeatures.filter(f => f !== feature);
                                        layer.setStyle({weight: 1.5, color: 'white', fillOpacity: 0.7});
                                    } else {
                                        if (selectedFeatures.length >= 2) {
                                            alert('Maximum 2 counties. Click "Clear" first.');
                                            return;
                                        }
                                        selectedFeatures.push(feature);
                                        layer.setStyle({weight: 4, color: '#ff7800', fillOpacity: 0.9});
                                    }
                                    updateComparisonUI();
                                });
                            }
                        }).addTo(map);

                        map.fitBounds(currentLayer.getBounds());

                        document.getElementById('legendPanel').classList.remove('hidden');
                        const content = document.getElementById('legendContent');
                        content.innerHTML = `<strong>${config.title}</strong><br><br>`;
                        config.colorBreaks.forEach((b, i) => {
                            content.innerHTML += `
                                <div class="legend-item">
                                    <div class="legend-color" style="background:${b.color}"></div>
                                    <div class="legend-text">
                                        <div class="legend-range">${config.ranges[i]}</div>
                                        <div class="legend-label">${b.label}</div>
                                    </div>
                                </div>
                            `;
                        });
                    })
                    .catch(err => console.error('Data load error:', err));
            } else {
                messageOverlay = L.rectangle(map.getBounds(), {color: "#fff", weight: 0, fillOpacity: 0.85}).addTo(map);
                currentLayer = messageOverlay;

                L.marker(map.getCenter(), {opacity: 0}).addTo(map).bindPopup(
                    `<div style="text-align:center; padding:20px; font-size:1.1em;">
                        <strong>No county-level data available for ${year}</strong><br><br>
                        County disaggregation only available for recent data (~2025).<br><br>
                        <strong>National Kenya value (${year}):</strong><br>${nationalData[file][year]}
                    </div>`,
                    {permanent: true, closeButton: false, autoClose: false}
                ).openPopup();
            }
        }

        updateMap();
    </script>
</body>
</html>
